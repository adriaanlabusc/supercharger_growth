<html lang="en">
  <head>
    <!-- TODO: change this to v4 once you have it up and running -->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <!-- <script src="countries.json"></script> -->
    <script src="world_geo_json_high.json"></script>
    <script src="super_charger_geo_json.json"></script>

    <script src="boston_rodents.json"></script>

  </head>
  <body>
    <h3>The map</h3>

    <div id="sliderContainer">
        <input id="timeslide" type="range" min="0" max="11" value="0" step="1"/><br>
        <span id="range">January</span>
    </div>

    <script>
      // console.log(superchargers);
      // example structure
      // {
      //   "id": 122,
      //   "locationId": "sanjuancapistranosupercharger",
      //   "name": "San Juan Capistrano, CA",
      //   "status": "OPEN",
      //   "address": {
      //     "street": "31971 Camino Capistrano",
      //     "city": "San Juan Capistrano",
      //     "state": "CA",
      //     "zip": "92675",
      //     "countryId": 100,
      //     "country": "USA",
      //     "regionId": 100,
      //     "region": "North America"
      //   },
      //   "gps": {
      //     "latitude": 33.498458,
      //     "longitude": -117.6632
      //   },
      //   "dateOpened": "2014-05-06",
      //   "stallCount": 7,
      //   "counted": true,
      //   "elevationMeters": 30,
      //   "powerKilowatt": 0,
      //   "solarCanopy": false,
      //   "battery": false,
      //   "statusDays": 0,
      //   "urlDiscuss": true
      // }

      // data is from https://supercharge.info/map

      var width = 1050;
      var height = 680;
      var inputValue = null;
      var month = ["January","February","March","April","May","June","July","August","September","October","November","December"];
      var svg = d3.select( "body" )
          .append( "svg" )
          .attr( "width", width )
          .attr( "height", height );

      // Append empty placeholder g element to the SVG
      // g will contain geometry elements
      var g = svg.append( "g" );

      // Width and Height of the whole visualization
      // Set Projection Parameters
      // Scale sets the scale of the map (ie 1 is the smallest, the larger the numbr the more zoomed in you are, you can fiddle with this until it works). Rotate and center set parameters for the project. A full global map fits nicely around 100. The extent of Boston lands at about 190000 with our extents.
      // Rotate the map sets the longitude of origin for our Albers projection. Center sets a single standard parallel at 42.313, about the latitude of Boston.
      // translate is a pixel offset, commonly specified to ensure that the center of the projection is in the center of the viewing area.
      var albersProjection = d3.geo.albers()
          .scale(400 ) //190000
          .rotate( [71.057,0] )
          .center( [0, 42.313] )
          .translate( [width/2,height/2] );

      var geoPath = d3.geo.path()
          .projection( albersProjection );

      g.selectAll( "path" )
          .data(world_geo_json.features)
          .enter()
          .append( "path" )
          .attr( "fill", "#ccc" )
          .attr( "stroke", "#333")
          .attr( "d", geoPath );
      var rodents = svg.append( "g" );
      var path = rodents.selectAll( "path" )
          .data(superchargers.features) //rodents_json.features )
          .enter()
          .append( "path" )
          .attr("fill", initialDate) // looks like this is run immediately for each path
          .attr("stroke", "#ccc")
          .attr("d", geoPath)
          .attr("class","incident")
          .on("mouseover", function(d){
            console.log('hello')
            console.log(d.properties.name);
              // d3.select("h2").text(d.properties.name); // LOCATION_STREET_NAME
              // d3.select(this).attr("class","incident hover");
          })
          .on("mouseout", function(d){
              d3.select("h2").text("");
              d3.select(this).attr("class","incident");
          });
      // when the input range changes update the value
      d3.select("#timeslide").on("input", function() {
          console.log('this.value');
          console.log(+this.value)
          // the `+` just casts this to an integer
          update(+this.value);
      });
      // update the fill of each SVG of class "incident"
      function update(value) {
          document.getElementById("range").innerHTML=month[value];
          inputValue = month[value];
          d3.selectAll(".incident")
              .attr("fill", dateMatch); // looks like giving it a function lets the method be called immediately
      }
      function dateMatch(data, value) {
          var d = new Date(data.properties.dateOpened); // OPEN_DT
          var m = month[d.getMonth()];
          if (inputValue == m) {
              // `this` seems to be the .incident
              console.log(this)
              this.parentElement.appendChild(this);
              return "red";
          } else {
              // why do we not need to remove anything? The total number of nodes do not seem to increase
              // despite this.
              return "#999";
          };
      }
      // TODO: this is basically a duplicate function
      function initialDate(d,i){
          var d = new Date(d.properties.dateOpened);
          var m = month[d.getMonth()];
          if (m == "January") {
              this.parentElement.appendChild(this);
              return "red";
          } else {
              return "#999";
          };
      }
    </script>


  </body>




</html>