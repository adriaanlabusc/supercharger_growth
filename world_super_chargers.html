<html lang="en">
  <head>
    <!-- TODO: change this to v4 once you have it up and running -->
    <script src="http://d3js.org/d3.v5.min.js" charset="utf-8"></script>
    <!-- <script src="countries.json"></script> -->
    <!-- data is originally from https://supercharge.info/map -->
    <script src="world_geo_json_medium.json"></script>
    <script src="super_charger_geo_json.json"></script>

    <script src="boston_superChargers.json"></script>
  </head>

  <style>
    .hover {
      fill: yellow;
    }

    #timeslide {
      width: 500px;
    }

    #location {
      float: right;
    }
  </style>

  <body>
    <h3>The map</h3>

    <div id="location"><h4></h4></div>

    <div id="sliderContainer">
      <input
        id="timeslide"
        type="range"
        min="0"
        max="2516"
        value="0"
        step="1"
      /><br />
      <span id="range">January</span>
    </div>

    <script>
      var width = 1250;
      var height = 680;
      var inputValue = null;

      var start = new Date("2012-12-19");
      var end = new Date("2019-11-09");
      var days = [];
      for (var d = start; d <= end; d.setDate(d.getDate() + 1)) {
        days.push(new Date(d));
      }

      var getDay = function(index) {
        return days[index];
      };

      var svg = d3
        .select("body")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

      // Append empty placeholder g element to the SVG
      // g will contain geometry elements
      var g = svg.append("g");

      // Width and Height of the whole visualization
      // Set Projection Parameters
      // Scale sets the scale of the map (ie 1 is the smallest, the larger the numbr the more zoomed in you are, you can fiddle with this until it works). Rotate and center set parameters for the project. A full global map fits nicely around 100. The extent of Boston lands at about 190000 with our extents.
      // Rotate the map sets the longitude of origin for our Albers projection. Center sets a single standard parallel at 42.313, about the latitude of Boston.
      // translate is a pixel offset, commonly specified to ensure that the center of the projection is in the center of the viewing area.
      var projection = d3
        .geoMercator()
        .scale(180)
        .rotate([0, 0])
        .center([0, 42.313])
        .translate([width / 2, height / 2]);

      // function zoomed() {
      //   g.attr(
      //     "transform",
      //     "translate(" + zoom.translate() + ")scale(" + zoom.scale() + ")"
      //   );
      // }

      var geoPath = d3.geoPath().projection(projection);

      g.selectAll("path")
        .data(world_geo_json.features)
        .enter()
        .append("path")
        .attr("fill", "#ccc")
        .attr("stroke", "#333")
        .attr("d", geoPath);

      var superChargers = svg.append("g");

      var superChargersPath = superChargers
        .selectAll("path")
        .data(superchargers.features) //superChargers_json.features )
        .enter()
        .append("path")
        .attr("fill", "red")
        .attr("stroke", "#ccc")
        .attr("opacity", "0.0") // initially none of them are visible
        .attr("d", geoPath)
        .attr("class", "incident")
        .on("mouseover", function(d) {
          d3.select("#location h4").text(
            d.properties.name + " " + d.properties.dateOpened
          ); // LOCATION_STREET_NAME
          d3.select(this).attr("class", "incident hover");
        })
        .on("mouseout", function(d) {
          d3.select("#location h4").text("");
          d3.select(this).attr("class", "incident");
        });

      var zoom = d3
        .zoom()
        .scaleExtent([1, 8])
        .on("zoom", zoomed);

      var pointRadius = 4.5;
      var zoomCounter = 0;

      function zoomed() {
        const { transform } = d3.event;
        // below two seem to move and zoom the map
        g.attr("transform", transform);
        g.attr("stroke-width", 1 / transform.k);
        // these will hopefully do the same for the dots
        superChargers.attr("transform", transform);
        // keep the outside line of the dots small
        superChargers.attr("stroke-width", 1 / transform.k);

        // for better performance do not resize
        // the dots every time this funciton runs...I hope anyway
        zoomCounter++;
        if (zoomCounter >= 10) {
          zoomCounter = 0;
          // this lets the dots get smaller as you zoom in
          superChargersPath.attr(
            "d",
            geoPath.pointRadius(function(d) {
              return pointRadius / transform.k;
            })
          );
        }
      }

      svg.call(zoom);

      // when the input range changes update the value
      d3.select("#timeslide").on("input", function() {
        // the `+` just casts this to an integer
        update(+this.value);
      });

      // update the fill of each SVG of class "incident"
      function update(value) {
        document.getElementById("range").innerHTML = getDay(value);
        inputValue = getDay(value);
        d3.selectAll(".incident").attr("opacity", dateMatch); // looks like giving it a function lets the method be called immediately
      }

      function dateMatch(data, value) {
        if (!data.properties.dateOpened) {
          return "0.0";
        }

        var dateOpened = new Date(data.properties.dateOpened);
        // 221 superchargers do not have dates so skip them
        if (dateOpened < new Date(inputValue)) {
          this.parentElement.appendChild(this);
          return "1.0";
        } else {
          // why do we not need to remove anything? The total number of nodes do not seem to increase
          // despite this.
          return "0.0";
        }
      }

      // the slider is on zero when the page loads
      update(0);

      document.addEventListener(
        "click",
        function(event) {
          // If the clicked element doesn't have the right selector, bail
          if (!event.target.matches(".click-me")) return;

          // Don't follow the link
          event.preventDefault();

          // Log the clicked element in the console
          console.log(event.target);
        },
        false
      );
    </script>
  </body>
</html>
